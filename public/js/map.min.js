var HexaMap;HexaMap=function(){function t(e,i){this.app=e,null==i&&(i=void 0),this._=t,this.loadMap(i||this.generateMap(8))}return t.CLOSEST_CELLS={2:{dx:1,dy:-1,key:12},5:{dx:1,dy:0,key:2},7:{dx:0,dy:1,key:4},6:{dx:-1,dy:1,key:6},3:{dx:-1,dy:0,key:8},1:{dx:0,dy:-1,key:10}},t.prototype.map=void 0,t.prototype.all=void 0,t.prototype.map_size=void 0,t.prototype.seeds=void 0,t.prototype.connectors=void 0,t.prototype.offset=void 0,t.prototype.state=0,t.DIRTY=1,t.COMPLETED=2,t.NO_WAY=4,t.prototype.getCell=function(t,e){return this.map[e]&&void 0!==this.map[e][t]?this.map[e][t]:void 0},t.prototype.loadMap=function(t,e){var i,s;return null==e&&(e=5),this.map=t,this.all=this._.getAllCells(t),this.map_size=this.getMapRect(this.map),this.app.c.width<this.map_size.width+4*this.app.CELL_SIDE&&(this.app.c.width=this.map_size.width+4*this.app.CELL_SIDE),this.app.c.height<this.map_size.height+4*this.app.CELL_SIDE&&(this.app.c.height=this.map_size.height+4*this.app.CELL_SIDE),s=.5*(this.app.c.width-this.map_size.width),i=.5*(this.app.c.height-this.map_size.height),this.offset={x:-this.map_size.from.x+s,y:-this.map_size.from.y+i},this.seeds=GameUtils.randItems(this.all,e),this.applySeeds(this.seeds),this.connectors=new Array},t.prototype.resetMap=function(){var t,e,i,s;for(s=this.all,e=0,i=s.length;i>e;e++)t=s[e],t.setFilled(!1),t.connectors=new Array;return this.connectors=new Array,this.applySeeds(),this.setDirty(!1),this.app.state=this.app.GAME,this.app.render()},t.prototype.randomizeMap=function(t,e){var i;return null==t&&(t=8),null==e&&(e=5),i=this.generateMap(t),this.loadMap(i,e),this.app.state=this.app.GAME,this.app.render()},t.prototype.applySeeds=function(t){var e,i,s,r,n;for(null==t&&(t=void 0),r=t||this.seeds,n=[],i=0,s=r.length;s>i;i++)e=r[i],n.push(e.setFilled());return n},t.prototype.getMapRect=function(){var t,e,i,s,r,n,o,p,l;for(o=l=n=p=0,r=this.all,e=0,i=r.length;i>e;e++)t=r[e],s=t.position(),s.x<o&&(o=s.x),s.x>n&&(n=s.x),s.y<l&&(l=s.y),s.y>p&&(p=s.y);return{from:{x:o,y:l},to:{x:n,y:p},width:n-o,height:p-l}},t.prototype.render=function(){var t,e,i,s,r,n,o,p,l;for(p=this.all,s=0,n=p.length;n>s;s++)t=p[s],t.render();for(l=this.connectors,i=r=0,o=l.length;o>r;i=++r)e=l[i],e.render()},t.prototype.countCells=function(t,e){return t||(t=this.map),this._.countCells(t,e)},t.countCells=function(t,e){var i,s,r,n,o,p,l,a,h;for(i=0,n=o=0,l=t.length;l>o;n=++o)for(h=t[n],r=p=0,a=h.length;a>p;r=++p)s=h[r],$.isFunction(e)?e(t[n][r])&&i++:t[n][r]===e&&i++;return i},t.prototype.waves=function(t,e,i){return this._.waves(t||this.map,e,i)},t.waves=function(t,e,i){var s,r,n,o,p,l,a,h,u,y,d,f,c,g,C,v,m;for(m=new Array(t.length),l=a=0,y=t.length;y>a;l=++a)v=t[l],m[l]=new Array(t[l].length).fill(0);for(m[i][e]=1,o=m.length*m[0].length;this.countCells(m,0)&&o--;)for(l=h=0,d=m.length;d>h;l=++h)for(v=m[l],p=u=0,f=v.length;f>u;p=++u)if(s=v[p],0===s){for(r=void 0,C=this.closestCells(t,p,l),g=0,c=C.length;c>g;g++)n=C[g],(!r||m[n.y][n.x]>0&&r>m[n.y][n.x])&&(r=m[n.y][n.x]);r&&(m[l][p]=r+1)}return m},t.prototype.closestCells=function(t,e,i){return t||(t=this.map),this._.closestCells(t,e,i)},t.closestCells=function(t,e,i){var s,r,n,o;s=[],o=this.CLOSEST_CELLS;for(n in o)r=o[n],t[i+r.dy]&&void 0!==t[i+r.dy][e+r.dx]&&s.push({x:e+r.dx,y:i+r.dy});return s},t.prototype.getCell=function(t,e){var i,s;return null!=(i=this.map)&&null!=(s=i[e])?s[t]:void 0},t.prototype.getCells=function(t){var e,i,s,r;for(null==t&&(t=[]),e=[],i=0,s=t.length;s>i;i++)r=t[i],void 0!==this.getCell(r.x,r.y)&&e.push(this.map[r.y][r.x]);return e},t.prototype.getAllCells=function(t){return null==t&&(t=void 0),t||(t=this.map),this._.getAllCells(t)},t.getAllCells=function(t){return GameUtils.flatten(t).filter(function(t){return void 0!==t})},t.splitFreeCells=function(t,e){var i;return i=e.freeCells(t),GameUtils.splitArray(i,function(t){return function(i){return!(t.CLOSEST_CELLS[3*(e.y-i.y+1)+e.x-i.x+1].key%4)}}(this))},t.prototype.generateMap=function(t,e){var i,s,r,n,o,p,l,a,h,u,y,d,f,c,g,C,v,m,x,_;for(null==t&&(t=5),null==e&&(e=.8),v=p=0;10>=p;v=++p){for(d=new Array(t),o=l=0,g=t-1;g>=0?g>=l:l>=g;o=g>=0?++l:--l){for(x=new Array(t),n=a=0,C=t-1;C>=0?C>=a:a>=C;n=C>=0?++a:--a)x[n]=Math.random()<e?new HexaCell(this.app,n,o):void 0;d[o]=x}if(i=this._.getAllCells(d),c=GameUtils.rand(i),r=t*t,c&&(_=this.waves(d,c.x,c.y),r=this.countCells(_,0)),t*t*e*.5>r){for(o=y=0,h=_.length;h>y;o=++y)for(m=_[o],n=f=0,u=m.length;u>f;n=++f)s=m[n],0===s&&(d[o][n]=void 0);break}}return d},t.prototype.setState=function(t,e){return null==e&&(e=!0),this.state=(this.state|t)^(e?0:t)},t.prototype.isState=function(t){return!!(this.state&t)},t.prototype.setDirty=function(e){return null==e&&(e=!0),this.state=(this.state|t.DIRTY)^(e?0:t.DIRTY)},t.prototype.isDirty=function(){return!!(this.state&t.DIRTY)},t.prototype.setCompleted=function(e){return null==e&&(e=!0),this.state=(this.state|t.COMPLETED)^(e?0:t.COMPLETED)},t.prototype.isCompleted=function(){return!!(this.state&t.COMPLETED)},t.prototype.setNoWay=function(e){return null==e&&(e=!0),this.state=(this.state|t.NO_WAY)^(e?0:t.NO_WAY)},t.prototype.isNoWay=function(){return!!(this.state&t.NO_WAY)},t}(),window.HexaMap=HexaMap;